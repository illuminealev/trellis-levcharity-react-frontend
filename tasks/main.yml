# Build LevCharity React Frontend locally and copy to server
- name: Check if lc directory exists
  stat:
    path: "{{ project_local_path }}/web/lc"
  delegate_to: localhost
  register: lc_directory

- name: Set allowed environment variables
  set_fact:
    allowed_env_vars:
      - recaptcha_site_key
      - turnstile_site_key
      - authorize_net_cad_client_secret
      - authorize_net_cad_login_id
      - authorize_net_usd_client_secret
      - authorize_net_usd_login_id
      - authorize_net_test_cad_client_secret
      - authorize_net_test_cad_login_id
      - authorize_net_test_usd_client_secret
      - authorize_net_test_usd_login_id
      - authorize_net_client_secret
      - authorize_net_login_id
      - authorize_net_test_client_secret
      - authorize_net_test_login_id
      - stripe_usd_publishable_key
      - stripe_cad_publishable_key
      - stripe_aud_publishable_key
      - stripe_gbp_publishable_key
      - stripe_eur_publishable_key
      - stripe_test_usd_publishable_key
      - stripe_test_cad_publishable_key
      - stripe_test_aud_publishable_key
      - stripe_test_gbp_publishable_key
      - stripe_test_eur_publishable_key
      - stripe_publishable_key
      - stripe_test_publishable_key
      - daf_chariot_cid
      - daf_chariot_sandbox_cid
      - banquest_public_key
      - banquest_test_public_key
      - paypal_client_id
      - paypal_test_client_id
- name: Create .env file with filtered environment variables
  copy:
    content: |
      {% for key in allowed_env_vars %}
      {% if site_env[key] is defined %}
      VITE_{{ key | upper }}="{{ site_env[key] }}"
      {% endif %}
      {% endfor %}
    dest: "{{ project_local_path }}/web/lc/.env"
  delegate_to: localhost
  when: lc_directory.stat.exists

- name: Install npm dependencies
  command: npm i
  delegate_to: localhost
  args:
    chdir: "{{ project_local_path }}/web/lc"
  when: lc_directory.stat.exists

- name: Build React frontend
  command: npm run build
  delegate_to: localhost
  args:
    chdir: "{{ project_local_path }}/web/lc"
  environment:
    NODE_ENV: production
  when: lc_directory.stat.exists

- name: Remove .env file after build
  file:
    path: "{{ project_local_path }}/web/lc/.env"
    state: absent
  delegate_to: localhost
  when: lc_directory.stat.exists

- name: Check if checkout directory exists
  stat:
    path: "{{ project_local_path }}/web/lc/checkout"
  delegate_to: localhost
  register: checkout_directory
  when: lc_directory.stat.exists

- name: Checkout directory missing
  ansible.builtin.fail:
    msg: "The React frontend checkout directory is missing after build"
  when: lc_directory.stat.exists and not checkout_directory.stat.exists

- name: Ensure lc directory exists on server
  file:
    path: "{{ deploy_helper.new_release_path }}/web/lc"
    state: directory
    mode: '0755'
  when: lc_directory.stat.exists and checkout_directory.stat.exists

- name: Copy built React frontend to server
  synchronize:
    src: "{{ project_local_path }}/web/lc/checkout/"
    dest: "{{ deploy_helper.new_release_path }}/web/lc/checkout"
    group: no
    owner: no
    rsync_opts: --chmod=Du=rwx,--chmod=Dg=rx,--chmod=Do=rx,--chmod=Fu=rw,--chmod=Fg=r,--chmod=Fo=r
  when: lc_directory.stat.exists and checkout_directory.stat.exists
