---
- name: Build LevCharity React Frontend package
  block:
    - name: Check if lc directory exists
      ansible.builtin.stat:
        path: "{{ project_root }}/current/web/lc"
      register: lc_directory

    - name: Check if npm is installed
      ansible.builtin.command: which npm
      register: npm_check
      failed_when: npm_check.rc != 0
      changed_when: false
      when: lc_directory.stat.exists

    - name: Check if package.json exists
      ansible.builtin.stat:
        path: "{{ project_root }}/current/web/lc/package.json"
      register: package_json
      when: lc_directory.stat.exists and npm_check.rc == 0

    - name: Install npm dependencies
      ansible.builtin.shell: npm install
      args:
        chdir: "{{ project_root }}/current/web/lc"
      when: package_json.stat.exists and npm_check.rc == 0
      environment:
        NODE_ENV: "{{ wordpress_env | default('production') }}"

    - name: Build frontend assets
      ansible.builtin.shell: npm run build
      args:
        chdir: "{{ project_root }}/current/web/lc"
      when: package_json.stat.exists and npm_check.rc == 0

    - name: Set proper ownership for lc directory
      ansible.builtin.file:
        path: "{{ project_root }}/current/web/lc"
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        recurse: yes
      become: yes
      when: lc_directory.stat.exists or package_json.stat.exists

    - name: Clean up node_modules directory
      ansible.builtin.file:
        path: "{{ project_root }}/current/web/lc/node_modules"
        state: absent
      become: yes
      when: lc_directory.stat.exists and npm_check.rc == 0
      ignore_errors: yes

  rescue:
    - name: Display error message
      ansible.builtin.debug:
        msg: "Failed to setup LevCharity React Frontend package. Check logs for details."

    - name: Clean up on failure
      ansible.builtin.file:
        path: "{{ project_root }}/current/web/lc"
        state: absent
      ignore_errors: yes