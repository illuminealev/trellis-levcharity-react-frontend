---
- name: Build LevCharity React Frontend package
  block:
    - name: Ensure npm cache directory exists
      ansible.builtin.file:
        path: "{{ project_root }}/shared/.npm-cache"
        state: directory
        mode: '0755'

    - name: Check if lc directory exists
      ansible.builtin.stat:
        path: "{{ project_root }}/current/web/lc"
      register: lc_directory

    - name: Check if npm is installed
      ansible.builtin.command: /usr/bin/npm --version
      register: npm_check
      failed_when: false
      changed_when: false
      when: lc_directory.stat.exists

    - name: Check if package.json exists
      ansible.builtin.stat:
        path: "{{ project_root }}/current/web/lc/package.json"
      register: package_json
      when: lc_directory.stat.exists and npm_check.rc == 0

    - name: Configure npm cache location
      ansible.builtin.shell: /usr/bin/npm config set cache {{ project_root }}/shared/.npm-cache
      when: package_json.stat.exists and npm_check.rc == 0
      environment:
        PATH: "/usr/bin:/usr/local/bin:{{ ansible_env.PATH }}"

    - name: Install npm dependencies with cache
      ansible.builtin.shell: /usr/bin/npm ci --cache {{ project_root }}/shared/.npm-cache
      args:
        chdir: "{{ project_root }}/current/web/lc"
      when: package_json.stat.exists and npm_check.rc == 0
      environment:
        PATH: "/usr/bin:/usr/local/bin:{{ ansible_env.PATH }}"
        NODE_ENV: "{{ wordpress_env | default('production') }}"

    - name: Build frontend assets
      ansible.builtin.shell: /usr/bin/npm run build
      args:
        chdir: "{{ project_root }}/current/web/lc"
      when: package_json.stat.exists and npm_check.rc == 0
      environment:
        PATH: "/usr/bin:/usr/local/bin:{{ ansible_env.PATH }}"

    - name: Clean up node_modules directory
      ansible.builtin.file:
        path: "{{ project_root }}/current/web/lc/node_modules"
        state: absent
      when: lc_directory.stat.exists and npm_check.rc == 0
