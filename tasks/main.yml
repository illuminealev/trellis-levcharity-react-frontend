---
- name: Build LevCharity React Frontend package
  block:
    - name: Check if lc directory exists
      ansible.builtin.stat:
        path: "{{ project_local_path }}/web/lc"
      register: lc_directory

    - name: Check if package.json exists
      ansible.builtin.stat:
        path: "{{ project_local_path }}/web/lc/package.json"
      register: package_json

    - name: Install npm dependencies
      ansible.builtin.shell: npm install
      args:
        chdir: "{{ project_local_path }}/web/lc"
      when: package_json.stat.exists
      environment:
        NODE_ENV: "{{ wordpress_env | default('production') }}"

    - name: Load environment variables from .env file
      ansible.builtin.slurp:
        src: "{{ project_local_path }}/.env"
      register: env_file
      ignore_errors: yes

    - name: Parse environment variables
      ansible.builtin.set_fact:
        env_vars: "{{ env_vars | default({}) | combine({item.split('=')[0]: item.split('=')[1:]|join('=')}) }}"
      loop: "{{ (env_file.content | b64decode).split('\n') }}"
      when:
        - env_file is succeeded
        - item != ''
        - not item.startswith('#')
        - '=' in item
      vars:
        env_vars: {}

    - name: Build frontend assets
      ansible.builtin.shell: npm run build
      args:
        chdir: "{{ project_local_path }}/web/lc"
      environment: "{{ env_vars | default({}) }}"
      when: package_json.stat.exists

    - name: Set proper ownership for lc directory
      ansible.builtin.file:
        path: "{{ project_local_path }}/web/lc"
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        recurse: yes
      become: yes
      when: lc_directory.stat.exists or package_json.stat.exists

  rescue:
    - name: Display error message
      ansible.builtin.debug:
        msg: "Failed to setup LevCharity React Frontend package. Check logs for details."

    - name: Clean up on failure
      ansible.builtin.file:
        path: "{{ project_local_path }}/web/lc"
        state: absent
      ignore_errors: yes